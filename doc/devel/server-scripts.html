<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-06-27 Tue 10:30 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PBench server script states and rsyncing from remotes</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Nick Dokos" />
<meta name="keywords" content="pbench" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="../../stylesheets/normalize.css" type="text/css"/>
<link rel="stylesheet" href="../../stylesheets/stylesheet.css" type="text/css"/>
<link rel="stylesheet" href="../../stylesheets/github-light.css" type="text/css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">PBench server script states and rsyncing from remotes</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgfffeab9">Introduction</a></li>
<li><a href="#org193f138">Directory structure</a></li>
<li><a href="#org72b5597">pbench-rsync-remote script: current state</a></li>
<li><a href="#orgcffdbea">pbench-rsync-remote script: future state</a>
<ul>
<li><a href="#org0bfc0ef">Slowness fix</a></li>
<li><a href="#orgf9b29e0">Processing part</a></li>
<li><a href="#orgf899afb">Delete script</a></li>
</ul>
</li>
<li><a href="#orgf8caef9">Notes</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgfffeab9" class="outline-2">
<h2 id="orgfffeab9">Introduction</h2>
<div class="outline-text-2" id="text-orgfffeab9">
<p>
The server scripts are invoked by cron at varying intervals. They
figure out what tarballs to process, then process them (what "process
them" means is specific to each server script), and then set things up
so that the next stage in the pipeline can do its job.
</p>

<p>
To figure out what tarballs to process in each invocation, the scripts
look into a <b>state</b> directory, specific to the script. Any symbolic
links to tarballs found there are added to the (script-internal) queue
for the current invocation of the script. The script will process all the
tarballs in its queue and then move the symbolic links to the state
directory for the next script.
</p>

<p>
Schematically each script does the following:
</p>

<div class="org-src-container">
<pre><code class="src src-shell">linksrc = state subdirectory for this script
linkdest = state sudbdirectory for next script

<span style="font-weight: bold; font-style: italic;">queue</span>=$(<span style="font-weight: bold;">find</span> list of tarballs<span style="font-weight: bold;"> in</span> $<span style="font-weight: bold; font-style: italic;">linksrc</span>)

<span style="font-weight: bold;">for</span> each element<span style="font-weight: bold;"> in</span> queue ;<span style="font-weight: bold;">do</span>
    process it
    <span style="font-weight: bold;">if</span> success
       move the symlink from $<span style="font-weight: bold; font-style: italic;">linksrc</span> to $<span style="font-weight: bold; font-style: italic;">linkdest</span>
    <span style="font-weight: bold;">else</span>
       move it to some error subdirectory
<span style="font-weight: bold;">done</span>
send mail with the list of successes and failures
</code></pre>
</div>

<p>
The <code>linksrc</code> and <code>linkdest</code> of each script are currently hard-coded, but
this is a bug: they are dependent on the configuration (production
does things differently than ec2 e.g.) so they should be specified in
the environment's server config file for each script and read from
there.
</p>
</div>
</div>


<div id="outline-container-org193f138" class="outline-2">
<h2 id="org193f138">Directory structure</h2>
<div class="outline-text-2" id="text-org193f138">
<p>
The state directories are kept on the server under each controller hostname
in the archive subdirectory of the pbench volume, e.g.
</p>

<p>
The structure looks like this:
</p>

<p>
&#x2026;/archive/fs-version-001/&lt;host&gt;/&#x2026;tarballs and MD5 sums&#x2026;
                                 /TODO
                                 /TO-COPY-SOS
                                 /TO-INDEX
                                 /INDEXED
                                 /TO-LINK
We will add some more subdirs (see below):
                                 /TO-SYNC (on remotes)
                                 /TO-PROCESS-REMOTE-TARBALLS
                                 /TO-DELETE-REMOTE-TARBALLS
</p>

<p>
In addition, there are some "retirement" subdirs, where tarballs
that have errors go to spend the rest of their days.
</p>
</div>
</div>

<div id="outline-container-org72b5597" class="outline-2">
<h2 id="org72b5597">pbench-rsync-remote script: current state</h2>
<div class="outline-text-2" id="text-org72b5597">
<p>
The <code>pbench-rsync-remote</code> script is a bit different. It takes the environment
name, the name of the remote server and the remote archive directory as arguments
and currently does something like this:
</p>

<pre class="example">

ARCHIVE=local-archive-directory
hosts=$(ssh $remoteserver 'cd $remotearchive; ls')

for host in $hosts ;do
    # make local host directory to receive the contents of the remote host directory
    mkdir -p $ARCHIVE/$prefix::$host
    cd $ARCHIVE/$prefix::$host
    # copy the remote contents over
    rsync $remoteserver:$remotearchive/$host/ .
    check MD5
    if success
       delete the tarball and its MD5 sum from the remote
    else
       report the failure
done

Add the tarballs that were good to the processing queue, sorted by size.
Submit them a few at a time for unpacking on the local system.
Send mail with the stats.
</pre>
<p>
The trouble is that the rsync is run for every host, whether that host
has any tarballs for copying or not. Unfortunately, that takes about 5
seconds, even if the host directory is empty. For a couple of hundred
hosts, we end up spending 20 minutes in this loop, even if there is
nothing to be done.
</p>
</div>
</div>

<div id="outline-container-orgcffdbea" class="outline-2">
<h2 id="orgcffdbea">pbench-rsync-remote script: future state</h2>
<div class="outline-text-2" id="text-orgcffdbea">
<p>
There are three things that we want to do:
</p>

<ul class="org-ul">
<li>fix the slowness identified above.</li>
<li>break up the script into an rsync part and a processing part.</li>
<li>add a script to delete tarballs (both archived and unpacked) on
the remote.</li>
</ul>
</div>

<div id="outline-container-org0bfc0ef" class="outline-3">
<h3 id="org0bfc0ef">Slowness fix</h3>
<div class="outline-text-3" id="text-org0bfc0ef">
<p>
We will fix this by having the remotes explicitly add symlinks to the
relevant tarballs into the host's TO-SYNC subdirectory.  This will be
done by changing the <code>linkdest</code> value of the <code>pbench-unpack-tarballs</code>
script to be TO-SYNC (<code>pbench-unpack-tarballs</code> and <code>pbench-edit-prefixes</code>
are the only scripts that are run in the EC2 environment - the latter uses
the TO-LINK subdir as its <code>linksrc</code>, but it has no <code>linkdest</code>: it just deletes
the links from the TO-LINK subdir after it's done).
</p>

<p>
The initial gathering of remote data will involve a single ssh invocation
which will use <code>find</code> to find all the tarballs to be processed by looking
in each TO-SYNC subdir. We can use <code>find</code> in symlink-resolving mode to get
the full pathnames of the tarballs themselves. The list will have to be
modified to add the MD5 sum files for each tarball, but that can be done
within the <code>pbench-rsync-remote</code> script purely algorithmically.
</p>

<p>
In principle, the list could be passed directly to <code>rsync</code> but it might
be long and we might run into command lenght problems, so it's better
to use xargs (although IIRC, interpolating arguments into a command is
a bit tricky).
</p>

<p>
After checking the MD5 sums, any tarballs that passed can be safely
deleted from the remote, MD5 sum file and TO-SYNC symlink included.
</p>

<p>
After the breakup, the above can be the first script, except that it
will have to pass the list of tarballs to the second part to be processed.
We will create a subdir, TO-PROCESS-REMOTE-TARBALLS, and the rsync part
will symlink the list of tarballs into each host's TO-PROCESS-REMOTE-TARBALLS
subdir.
</p>
</div>
</div>

<div id="outline-container-orgf9b29e0" class="outline-3">
<h3 id="orgf9b29e0">Processing part</h3>
<div class="outline-text-3" id="text-orgf9b29e0">
<p>
The processing part will generate a list of tarballs to process, again by
doing a <code>find</code> on the TO-PROCESS-REMOTE-TARBALLS subdirs. It will sort
the tarballs by size and it will trickle them into the TODO subdirs
of each host, where <code>pbench-unpack-tarballs</code> can find them and process
them through the full production pipeline.
</p>

<p>
Once a tarball is processed, the corresponding unpacked directory
on the remote can be deleted. This will be done in the third script
below - all that the processing script will do is (you guessed it)
plant a symlink into yet another subdir, TO-DELETE-REMOTE-TARBALLS.
</p>
</div>
</div>

<div id="outline-container-orgf899afb" class="outline-3">
<h3 id="orgf899afb">Delete script</h3>
<div class="outline-text-3" id="text-orgf899afb">
<p>
The delete script will do the usual <code>find</code> through the
TO-DELETE-REMOTE-TARBALLS subdirs for each host and arrange for
each of them to be deleted from the remote.
</p>

<p>
The point is that the links will stick around until explicitly moved
so if there are problems reaching the remote, the deletion will be delayed
but it will eventually happen. Of course, if we cannot reach the remote,
mail to that effect will be sent out.
</p>
</div>
</div>
</div>


<div id="outline-container-orgf8caef9" class="outline-2">
<h2 id="orgf8caef9">Notes</h2>
<div class="outline-text-2" id="text-orgf8caef9">
<p>
Note that we'll need a separate rsync script for each remote environment,
and they might very well be running at different frequencies. The processing
script can be a single script. The delete script might be a single script
or multiple scripts, one per remote environment. That's TBD.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Page updated: 2017-06-27 Tue 10:30</p>
</div>
</body>
</html>
